{% extends "base.html" %}

{% block title %}Loan Management - Banking Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-money-bill-wave"></i> Loan Management
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-contract"></i> Apply for Loan</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('apply_loan') }}">
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">Customer</label>
                        <select class="form-select" id="customer_id" name="customer_id" required>
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer[0] }}">{{ customer[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="loan_type" class="form-label">Loan Type</label>
                        <select class="form-select" id="loan_type" name="loan_type" required>
                            <option value="">Select Loan Type</option>
                            <option value="PERSONAL">Personal Loan</option>
                            <option value="HOME">Home Loan</option>
                            <option value="CAR">Car Loan</option>
                            <option value="BUSINESS">Business Loan</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="principal_amount" class="form-label">Principal Amount</label>
                        <input type="number" class="form-control" id="principal_amount" name="principal_amount" 
                               min="1000" step="1000" required>
                    </div>
                    <div class="mb-3">
                        <label for="interest_rate" class="form-label">Interest Rate (%)</label>
                        <input type="number" class="form-control" id="interest_rate" name="interest_rate" 
                               min="1" max="30" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="tenure_months" class="form-label">Tenure (Months)</label>
                        <select class="form-select" id="tenure_months" name="tenure_months" required>
                            <option value="">Select Tenure</option>
                            <option value="12">12 Months (1 Year)</option>
                            <option value="24">24 Months (2 Years)</option>
                            <option value="36">36 Months (3 Years)</option>
                            <option value="60">60 Months (5 Years)</option>
                            <option value="120">120 Months (10 Years)</option>
                            <option value="180">180 Months (15 Years)</option>
                            <option value="240">240 Months (20 Years)</option>
                            <option value="300">300 Months (25 Years)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">EMI Calculator</h6>
                                <p class="card-text" id="emi-preview">
                                    Enter loan details to see EMI calculation
                                </p>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane"></i> Apply for Loan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Loan Applications</h5>
            </div>
            <div class="card-body">
                {% if loans %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Principal</th>
                                <th>Rate</th>
                                <th>Tenure</th>
                                <th>EMI</th>
                                <th>Outstanding</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in loans %}
                            <tr>
                                <td>{{ loan[0] }}</td>
                                <td>{{ loan[1] }}</td>
                                <td>
                                    {% if loan[2] == 'PERSONAL' %}
                                        <span class="badge bg-info">Personal</span>
                                    {% elif loan[2] == 'HOME' %}
                                        <span class="badge bg-success">Home</span>
                                    {% elif loan[2] == 'CAR' %}
                                        <span class="badge bg-warning">Car</span>
                                    {% elif loan[2] == 'BUSINESS' %}
                                        <span class="badge bg-primary">Business</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">₹{{ "{:,.0f}".format(loan[3]) }}</td>
                                <td>{{ loan[4] }}%</td>
                                <td>{{ loan[5] }} months</td>
                                <td class="text-end">₹{{ "{:,.2f}".format(loan[6]) if loan[6] else 'N/A' }}</td>
                                <td class="text-end">₹{{ "{:,.2f}".format(loan[7]) if loan[7] else 'N/A' }}</td>
                                <td>
                                    {% if loan[9] == 'PENDING' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif loan[9] == 'APPROVED' %}
                                        <span class="badge bg-success">Approved</span>
                                    {% elif loan[9] == 'REJECTED' %}
                                        <span class="badge bg-danger">Rejected</span>
                                    {% elif loan[9] == 'DISBURSED' %}
                                        <span class="badge bg-info">Disbursed</span>
                                    {% elif loan[9] == 'CLOSED' %}
                                        <span class="badge bg-secondary">Closed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if loan[9] == 'PENDING' %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="processLoan({{ loan[0] }}, 'APPROVE')" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="processLoan({{ loan[0] }}, 'REJECT')" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% elif loan[9] == 'APPROVED' %}
                                        <button type="button" class="btn btn-outline-info" 
                                                onclick="disburseLoan({{ loan[0] }})" title="Disburse">
                                            <i class="fas fa-money-bill"></i>
                                        </button>
                                        {% elif loan[9] == 'DISBURSED' %}
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="makePayment({{ loan[0] }})" title="Make Payment">
                                            <i class="fas fa-credit-card"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="viewLoanDetails({{ loan[0] }})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No loan applications found</h5>
                    <p class="text-muted">Submit your first loan application using the form on the left.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Loan Processing Modal -->
<div class="modal fade" id="loanProcessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loanProcessModalTitle">Process Loan Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loanProcessForm">
                    <input type="hidden" id="process_loan_id" name="loan_id">
                    <input type="hidden" id="process_action" name="action">
                    <div class="mb-3">
                        <label for="process_remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="process_remarks" name="remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitLoanProcess()">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// EMI Calculator
function calculateEMI() {
    const principal = parseFloat(document.getElementById('principal_amount').value) || 0;
    const rate = parseFloat(document.getElementById('interest_rate').value) || 0;
    const tenure = parseInt(document.getElementById('tenure_months').value) || 0;
    
    if (principal > 0 && rate > 0 && tenure > 0) {
        const monthlyRate = rate / (12 * 100);
        const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenure) / 
                   (Math.pow(1 + monthlyRate, tenure) - 1);
        
        const totalAmount = emi * tenure;
        const totalInterest = totalAmount - principal;
        
        document.getElementById('emi-preview').innerHTML = `
            <strong>Monthly EMI:</strong> ₹${emi.toLocaleString('en-IN', {maximumFractionDigits: 2})}<br>
            <strong>Total Interest:</strong> ₹${totalInterest.toLocaleString('en-IN', {maximumFractionDigits: 2})}<br>
            <strong>Total Amount:</strong> ₹${totalAmount.toLocaleString('en-IN', {maximumFractionDigits: 2})}
        `;
    } else {
        document.getElementById('emi-preview').innerHTML = 'Enter loan details to see EMI calculation';
    }
}

// Add event listeners for EMI calculation
document.getElementById('principal_amount').addEventListener('input', calculateEMI);
document.getElementById('interest_rate').addEventListener('input', calculateEMI);
document.getElementById('tenure_months').addEventListener('change', calculateEMI);

function processLoan(loanId, action) {
    document.getElementById('process_loan_id').value = loanId;
    document.getElementById('process_action').value = action;
    document.getElementById('loanProcessModalTitle').textContent = 
        action === 'APPROVE' ? 'Approve Loan Application' : 'Reject Loan Application';
    
    const modal = new bootstrap.Modal(document.getElementById('loanProcessModal'));
    modal.show();
}

function submitLoanProcess() {
    const loanId = document.getElementById('process_loan_id').value;
    const action = document.getElementById('process_action').value;
    const remarks = document.getElementById('process_remarks').value;
    
    // In a real application, this would be an AJAX call
    alert(`Loan ${loanId} would be ${action.toLowerCase()}ed with remarks: ${remarks}`);
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('loanProcessModal'));
    modal.hide();
}

function disburseLoan(loanId) {
    const accountId = prompt('Enter account ID for disbursement:');
    if (accountId) {
        alert(`Loan ${loanId} would be disbursed to account ${accountId}`);
    }
}

function makePayment(loanId) {
    const amount = prompt('Enter payment amount:');
    if (amount && parseFloat(amount) > 0) {
        alert(`Payment of ₹${amount} would be processed for loan ${loanId}`);
    }
}

function viewLoanDetails(loanId) {
    alert(`Loan details would be displayed for loan ID: ${loanId}`);
}
</script>
{% endblock %}